{
  "test_cases": [
    {
      "id": 1,
      "category": "RULES_HIT_HOUSEKEEPING",
      "user_message": "Necesito toallas limpias",
      "expected_behavior": {
        "routing_layer": "rules",
        "intent": "ticket_request",
        "area": "HOUSEKEEPING",
        "routing_source": "rules",
        "routing_confidence": ">=0.85",
        "routing_reason": "Keyword-based: X matches",
        "should_ask_clarification": false,
        "flow": "Rules → Identity check → Confirmation → DB"
      },
      "explanation": "Keyword 'toallas' es match directo en HOUSEKEEPING_PATTERNS. Rules detecta con alta confianza, LLM nunca se llama."
    },
    {
      "id": 2,
      "category": "RULES_HIT_MANTENCION",
      "user_message": "No funciona el aire acondicionado",
      "expected_behavior": {
        "routing_layer": "rules",
        "intent": "ticket_request",
        "area": "MANTENCION",
        "routing_source": "rules",
        "routing_confidence": ">=0.85",
        "routing_reason": "Keyword-based: X matches",
        "should_ask_clarification": false,
        "flow": "Rules → Identity check → Confirmation → DB"
      },
      "explanation": "Keywords 'no funciona' + 'aire acondicionado' = múltiples matches en MANTENCION_PATTERNS. Routing determinístico."
    },
    {
      "id": 3,
      "category": "RULES_HIT_RECEPCION",
      "user_message": "Quiero hacer late checkout",
      "expected_behavior": {
        "routing_layer": "rules",
        "intent": "ticket_request",
        "area": "RECEPCION",
        "routing_source": "rules",
        "routing_confidence": ">=0.85",
        "routing_reason": "Keyword-based: X matches",
        "should_ask_clarification": false,
        "flow": "Rules → Identity check → Confirmation → DB"
      },
      "explanation": "Keywords 'late checkout' son match directo en RECEPCION_PATTERNS. Rules lo resuelve instantáneamente."
    },
    {
      "id": 4,
      "category": "RULES_HIT_GERENCIA",
      "user_message": "Quiero presentar una queja formal, esto es inaceptable",
      "expected_behavior": {
        "routing_layer": "rules",
        "intent": "ticket_request",
        "area": "GERENCIA",
        "routing_source": "rules",
        "routing_confidence": ">=0.85",
        "routing_reason": "Keyword-based: X matches",
        "should_ask_clarification": false,
        "flow": "Rules → Identity check → Confirmation → DB"
      },
      "explanation": "Keywords 'queja' + 'inaceptable' son múltiples matches en GERENCIA_PATTERNS. Escalamiento automático a gerencia."
    },
    {
      "id": 5,
      "category": "LLM_HIGH_CONFIDENCE",
      "user_message": "Pueden traerme almohadas extra por favor",
      "expected_behavior": {
        "routing_layer": "llm",
        "intent": "ticket_request",
        "area": "HOUSEKEEPING",
        "routing_source": "llm",
        "routing_confidence": ">=0.80",
        "routing_reason": "LLM classification",
        "should_ask_clarification": false,
        "flow": "Rules miss → LLM → High confidence → Confirmation → DB"
      },
      "explanation": "Rules no tiene 'almohadas' en keywords (gap en reglas). LLM clasifica HOUSEKEEPING con alta confianza. Pasa threshold 0.65."
    },
    {
      "id": 6,
      "category": "LLM_LOW_CONFIDENCE_CLARIFICATION",
      "user_message": "Tengo un problema en mi habitación",
      "expected_behavior": {
        "routing_layer": "llm",
        "intent": "ticket_request",
        "area": "SUPERVISION",
        "routing_source": "llm",
        "routing_confidence": "<0.65",
        "routing_reason": "LLM classification",
        "should_ask_clarification": true,
        "clarification_menu": "1️⃣ Mantenimiento / 2️⃣ Housekeeping / 3️⃣ Recepción / 4️⃣ Otro",
        "flow": "Rules miss → LLM → Low confidence → ASK USER (1-4) → User picks → DB with routing_source='clarification'"
      },
      "explanation": "Mensaje muy ambiguo. LLM retorna SUPERVISION con confidence ~0.30. Sistema detecta <0.65 y pregunta al usuario directamente."
    },
    {
      "id": 7,
      "category": "CLARIFICATION_USER_CHOICE",
      "user_message_1": "Necesito ayuda urgente",
      "user_message_2": "2",
      "expected_behavior": {
        "routing_layer": "clarification",
        "state_after_msg1": "GH_AREA_CLARIFICATION",
        "clarification_shown": true,
        "user_choice": "2",
        "final_area": "HOUSEKEEPING",
        "routing_source": "clarification",
        "routing_confidence": 1.0,
        "routing_reason": "User chose option 2: HOUSEKEEPING",
        "flow": "LLM → Low confidence → Ask (1-4) → User picks '2' → HOUSEKEEPING → Confirmation → DB"
      },
      "explanation": "Usuario dice 'ayuda urgente' (ambiguo) → Sistema pregunta → Usuario elige '2' (Housekeeping) → Confidence=1.0 porque usuario confirmó explícitamente."
    },
    {
      "id": 8,
      "category": "MULTI_DEPARTMENT_SUPERVISION",
      "user_message": "Necesito toallas y el aire no funciona",
      "expected_behavior": {
        "routing_layer": "llm",
        "intent": "ticket_request",
        "area": "SUPERVISION",
        "routing_source": "llm",
        "routing_confidence": "~0.50",
        "routing_reason": "LLM classification",
        "should_ask_clarification": true,
        "flow": "Rules ambiguo (2 áreas) → LLM → SUPERVISION confidence <0.65 → Ask user (1-4) → User picks → DB"
      },
      "explanation": "Mensaje tiene keywords de HOUSEKEEPING ('toallas') Y MANTENCION ('aire no funciona'). Rules NO match (scores similares). LLM clasifica SUPERVISION con confianza media-baja. Sistema pide aclaración."
    },
    {
      "id": 9,
      "category": "FAQ_NOT_TICKET",
      "user_message": "¿A qué hora es el desayuno?",
      "expected_behavior": {
        "routing_layer": "llm",
        "intent": "not_understood",
        "area": null,
        "routing_source": "n/a",
        "routing_confidence": 0.0,
        "should_create_ticket": false,
        "flow": "Rules miss → LLM → intent='not_understood' → FAQ module handles it (no ticket created)"
      },
      "explanation": "Pregunta de información pura. LLM clasifica como 'not_understood'. Orchestrator pasa a FAQ fallback. NO se crea ticket."
    },
    {
      "id": 10,
      "category": "EDGE_CASE_MIXED_GREETING_TICKET",
      "user_message": "Hola, no tengo agua caliente en mi habitación 305",
      "expected_behavior": {
        "routing_layer": "rules",
        "intent": "ticket_request",
        "area": "MANTENCION",
        "routing_source": "rules",
        "routing_confidence": ">=0.85",
        "routing_reason": "Keyword-based: X matches",
        "extracted_room": "305",
        "should_ask_clarification": false,
        "flow": "Rules → MANTENCION (ignora 'Hola') → Identity (room ya extraído) → Confirmation → DB"
      },
      "explanation": "Mensaje mixto (saludo + problema). Rules ignora 'Hola' y detecta 'agua caliente' = MANTENCION. LLM extrae room='305'. Flow normal."
    }
  ],
  "test_instructions": {
    "how_to_validate": [
      "1. Envía cada user_message por WhatsApp",
      "2. Verifica que el área clasificada coincida con expected_behavior.area",
      "3. Verifica que should_ask_clarification coincida (si true, debe mostrar menú 1-4)",
      "4. Al confirmar ticket, verifica en DB que routing_source/reason/confidence se guardaron correctamente",
      "5. Para caso 7, envía primero msg1, luego msg2 y verifica que area final sea HOUSEKEEPING"
    ],
    "success_criteria": {
      "rules_efficiency": "Casos 1-4 deben resolverse sin llamar LLM (check logs '[NLU] ✅ RULES HIT')",
      "confidence_threshold": "Casos 6, 7, 8 deben activar clarificación (confidence < 0.65)",
      "metadata_persistence": "Todos los tickets deben tener routing_source, routing_reason, routing_confidence, routing_version en DB",
      "area_correctness": "100% de los casos deben rutear al área correcta"
    }
  },
  "metadata": {
    "version": "v1",
    "created_for": "Mega Issue - Routing Guardrails Implementation",
    "test_coverage": {
      "rules_layer": "Casos 1-4, 10",
      "llm_layer": "Casos 5, 6, 8, 9",
      "clarification_flow": "Casos 6, 7, 8",
      "edge_cases": "Casos 9, 10",
      "all_5_areas": "HOUSEKEEPING (1,5,7), MANTENCION (2,10), RECEPCION (3), GERENCIA (4), SUPERVISION (6,8)"
    }
  }
}
