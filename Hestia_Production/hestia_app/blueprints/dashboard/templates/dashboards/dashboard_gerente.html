{% extends "base.html" %}
{% block title %}Dashboard — Gerente{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="page-title mb-0">Resumen general</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('tickets.ticket_create') }}" class="btn btn-accent">Nuevo ticket</a>
    <a href="{{ url_for('tickets.tickets') }}" class="btn btn-outline-dark">Ver tickets</a>
  </div>
</div>

<!-- KPI cards -->
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card stat-card">
      <div class="card-body">
        <div class="text-muted">Críticos</div>
        <div class="display-5 fw-bold">{{ kpis.critical or 0 }}</div>
        <div class="small text-muted">Tickets en ventana crítica (SLA)</div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card stat-card">
      <div class="card-body">
        <div class="text-muted">Activos</div>
        <div class="display-5 fw-bold">{{ kpis.active or 0 }}</div>
        <div class="small text-muted">En curso en toda la organización</div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card stat-card">
      <div class="card-body">
        <div class="text-muted">Resueltos (hoy)</div>
        <div class="display-5 fw-bold">{{ kpis.resolved_today or 0 }}</div>
        <div class="small text-muted">Cierres del día</div>
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row g-3 mt-1">
  <div class="col-xl-8">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">Evolución (últimos 7 días)</div>
      <div class="card-body" style="height:360px">
        <canvas id="tsChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card mb-3">
      <div class="card-header bg-white fw-semibold">% por área</div>
      <div class="card-body" style="height:180px">
        <canvas id="areaChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-header bg-white fw-semibold">Críticos por prioridad</div>
      <div class="card-body" style="height:180px">
        <canvas id="critChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Critical table -->
<div class="card mt-3">
  <div class="card-header bg-white fw-semibold">Últimos críticos</div>
  <div class="table-responsive">
    <table class="table mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Área</th><th>Prioridad</th><th>Detalle</th><th>Creado</th><th>Vence</th>
        </tr>
      </thead>
      <tbody>
      {% for t in (kpis.last_critical or []) %}
        <tr>
          <td>{{ t.id }}</td>
          <td>{{ t.area }}</td>
          <td>
            <span class="badge
              {% if t.prioridad=='URGENTE' %} bg-danger
              {% elif t.prioridad=='ALTA' %} bg-warning text-dark
              {% elif t.prioridad=='MEDIA' %} bg-info
              {% else %} bg-secondary {% endif %}">
              {{ t.prioridad }}
            </span>
          </td>
          <td class="text-truncate" style="max-width: 380px">{{ t.detalle }}</td>
          <td><small>{{ t.created_at|short_dt }}</small></td>
          <td class="{{ 'text-danger fw-semibold' if t.is_critical }}">
            <small>{{ t.due_at|short_dt if t.due_at else '-' }}</small>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="6" class="text-center text-muted py-4">Sin resultados</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Gerencia: Indicadores en tiempo real (30d) ===== -->
<div class="row g-3 mt-3">
  <div class="col-xl-3 col-md-6">
    <div class="card h-100"><div class="card-body">
      <div class="text-muted">TTR promedio (30d)</div>
      <div id="g-avg-ttr" class="display-6 fw-bold">—</div>
      <div class="small text-muted">minutos</div>
    </div></div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card h-100"><div class="card-body">
      <div class="text-muted">Abiertos</div>
      <div id="g-open" class="display-6 fw-bold">—</div>
      <div class="small text-muted">en toda la organización</div>
    </div></div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card h-100"><div class="card-body">
      <div class="text-muted">Sin asignar</div>
      <div id="g-unassigned" class="display-6 fw-bold">—</div>
      <div class="small text-muted">pendientes por asignar</div>
    </div></div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card h-100 border-warning"><div class="card-body">
      <div class="text-warning">% SLA (real)</div>
      <div id="g-sla-real" class="display-6 fw-bold">—</div>
      <div class="small text-muted">promedio por área (30d)</div>
    </div></div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">SLA real vs objetivo</div>
      <div class="card-body" style="height:300px"><canvas id="g-sla-vs"></canvas></div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">TTR promedio por área (min)</div>
      <div class="card-body" style="height:300px"><canvas id="g-ttr-area"></canvas></div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">% SLA por tipo (30d)</div>
      <div class="card-body" style="height:300px">
        <canvas id="g-sla-tipo"></canvas>
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">Tickets reincidentes (30d)</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Tipo</th>
                <th>Ubicación</th>
                <th>Incidencias</th>
                <th>Último</th>
              </tr>
            </thead>
            <tbody id="g-recurr-tbody">
              <tr><td colspan="4" class="text-center text-muted py-3">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-3 mt-1">
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">Mix de incidencias (últimos 30d)</div>
      <div class="card-body" style="height:300px"><canvas id="g-mix-area"></canvas></div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">Tickets por día (30d)</div>
      <div class="card-body" style="height:300px"><canvas id="g-ts-30"></canvas></div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header bg-white fw-semibold">Tickets abiertos (asignado · transcurrido)</div>
  <div class="table-responsive">
    <table class="table mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Área</th><th>Prioridad</th><th>Detalle</th><th>Asignado</th><th>Transcurrido</th><th>Vence</th>
        </tr>
      </thead>
      <tbody id="g-open-tbody">
        <tr><td colspan="7" class="text-center text-muted py-3">Cargando…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- No asignados -->
<div class="card mt-3">
  <div class="card-header bg-white fw-semibold">No asignados</div>
  <div class="table-responsive">
    <table class="table mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Área</th><th>Prioridad</th><th>Detalle</th><th>Ubicación</th><th>Creado</th><th>Vence</th><th>Espera</th>
        </tr>
      </thead>
      <tbody id="g-unassigned-tbody">
        <tr><td colspan="8" class="text-center text-muted py-3">Cargando…</td></tr>
      </tbody>
    </table>
  </div>
</div>


{% endblock %}



{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Palette from CSS variables
  const css = getComputedStyle(document.documentElement);
  const BRAND    = css.getPropertyValue('--brand').trim()    || '#16242D';
  const ACCENT   = css.getPropertyValue('--accent').trim()   || '#41D4A8';
  const WARNING  = css.getPropertyValue('--warning').trim()  || '#C09B5F';
  const CRITICAL = css.getPropertyValue('--critical').trim() || '#E5484D';

  // Data from backend (with safe fallbacks)
  const ts7   = {{ (charts.resolved_last7 or []) | tojson }};
  const byArea = {{ (kpis.by_area or {}) | tojson }};
  const critByPri = {{ (charts.critical_by_priority or {'labels':[],'values':[]}) | tojson }};

  // Build 7-day labels & counts (resolved only)
  const tsLabels = ts7.map(x => x.date);
  const tsValues = ts7.map(x => x.count);

  // Line: resolved last 7 days
  new Chart(document.getElementById('tsChart'), {
    type: 'line',
    data: {
      labels: tsLabels,
      datasets: [{
        label: 'Resueltos',
        data: tsValues,
        tension: 0.35,
        borderColor: ACCENT,
        backgroundColor: ACCENT + '33',
        fill: true,
        pointRadius: 3
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });

  // Pie: by area
  new Chart(document.getElementById('areaChart'), {
    type: 'doughnut',
    data: { labels: Object.keys(byArea), datasets: [{ data: Object.values(byArea), backgroundColor: [ACCENT, WARNING, BRAND, CRITICAL] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });

  // Bar: critical by priority
  new Chart(document.getElementById('critChart'), {
    type: 'bar',
    data: { labels: critByPri.labels || [], datasets: [{ label: 'Críticos', data: critByPri.values || [], backgroundColor: [CRITICAL, WARNING, BRAND, ACCENT] }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });
</script>

<script>
(async function(){
  // re-use palette
  const css = getComputedStyle(document.documentElement);
  const BRAND    = css.getPropertyValue('--brand').trim()    || '#16242D';
  const ACCENT   = css.getPropertyValue('--accent').trim()   || '#41D4A8';
  const WARNING  = css.getPropertyValue('--warning').trim()  || '#C09B5F';
  const CRITICAL = css.getPropertyValue('--critical').trim() || '#E5484D';

  const r = await fetch("{{ url_for('gerencia.api_gerencia_summary') }}");
  if(!r.ok) return;
  const j = await r.json();

    // --- TTR por tipo (min)
  if (j.ttr_by_type) {
    const tiposTT = Object.keys(j.ttr_by_type || {});
    const valsTT  = tiposTT.map(k => j.ttr_by_type[k]);
    const el = document.getElementById('g-ttr-tipo');
    if (el) {
      new Chart(el, {
        type: 'bar',
        data: { labels: tiposTT, datasets: [{ label: 'min', data: valsTT, backgroundColor: BRAND }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }

  // --- SLA vs Objetivo por tipo (usa reglas slarules si existen; fallback a env)
  if (j.sla_vs_target_tipo) {
    const lbls = j.sla_vs_target_tipo.map(x => x.tipo);
    const real = j.sla_vs_target_tipo.map(x => x.real);
    const obj  = j.sla_vs_target_tipo.map(x => x.objetivo);
    const el = document.getElementById('g-sla-vs-tipo');
    if (el) {
      new Chart(el, {
        type: 'bar',
        data: { labels: lbls, datasets: [
          { label:'Real', data: real, backgroundColor: ACCENT },
          { label:'Objetivo', data: obj, backgroundColor: WARNING }
        ]},
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{ position:'bottom' } } }
      });
    }
  }

  // --- No asignados table
  try {
    const r2 = await fetch("{{ url_for('gerencia.api_gerencia_sin_asignar') }}");
    if (r2.ok) {
      const u = await r2.json();
      const Tu = document.getElementById('g-unassigned-tbody');
      if (Tu) {
        const rows = (u.items || []).map(t => `
          <tr>
            <td>#${t.id}</td>
            <td>${t.area || '—'}</td>
            <td>${t.prioridad || '—'}</td>
            <td class="text-truncate" style="max-width:380px">${t.detalle || ''}</td>
            <td>${t.ubicacion || '—'}</td>
            <td><small>${t.created_at || '—'}</small></td>
            <td><small>${t.due_at || '—'}</small></td>
            <td>${t.elapsed_min != null ? (t.elapsed_min + ' min') : '—'}</td>
          </tr>
        `).join('');
        Tu.innerHTML = rows || `<tr><td colspan="8" class="text-center text-muted py-3">Sin no asignados</td></tr>`;
      }
    }
  } catch (_) {}


  // KPI tiles
  document.getElementById('g-avg-ttr').textContent = (j.avg_ttr_30d ?? 0);
  document.getElementById('g-open').textContent = (j.snapshot?.open_total ?? 0);
  document.getElementById('g-unassigned').textContent = (j.snapshot?.open_unassigned ?? 0);

  // SLA (avg across areas)
  const slaVals = Object.values(j.sla_by_area || {});
  const avgSla  = slaVals.length ? (slaVals.reduce((a,b)=>a+b,0)/slaVals.length) : 0;
  document.getElementById('g-sla-real').textContent = (avgSla || 0).toFixed(1) + '%';

  // SLA vs target (grouped bar)
  const areas = (j.sla_vs_target || []).map(x => x.area);
  const real  = (j.sla_vs_target || []).map(x => x.real);
  const goal  = (j.sla_vs_target || []).map(x => x.objetivo);
  new Chart(document.getElementById('g-sla-vs'), {
    type: 'bar',
    data: { labels: areas, datasets: [
      { label:'Real', data: real, backgroundColor: ACCENT },
      { label:'Objetivo', data: goal, backgroundColor: WARNING }
    ]},
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{ position:'bottom' } } }
  });

  // TTR by area (bar)
  const ttrAreas = Object.keys(j.ttr_by_area || {});
  const ttrVals  = ttrAreas.map(a => j.ttr_by_area[a]);
  new Chart(document.getElementById('g-ttr-area'), {
    type:'bar',
    data:{ labels:ttrAreas, datasets:[{ label:'min', data:ttrVals, backgroundColor: BRAND }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });

  // Mix by area (pie)
  const mixAreas = Object.keys(j.mix_by_area || {});
  const mixVals  = mixAreas.map(a => j.mix_by_area[a]);
  new Chart(document.getElementById('g-mix-area'), {
    type:'doughnut',
    data:{ labels:mixAreas, datasets:[{ data:mixVals, backgroundColor:[ACCENT, WARNING, BRAND, CRITICAL] }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
  });

  // Tickets per day (line)
  const tsLabels = (j.tickets_per_day || []).map(x=>x.date);
  const tsVals   = (j.tickets_per_day || []).map(x=>x.count);
  new Chart(document.getElementById('g-ts-30'), {
    type:'line',
    data:{ labels:tsLabels, datasets:[{ label:'Tickets', data:tsVals, borderColor:ACCENT, backgroundColor:ACCENT+'33', fill:true, tension:.35, pointRadius:2 }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });

    /* === SLA por tipo (30d) ===
     Espera j.sla_by_type_tipo como objeto:
     { "ELECTRICIDAD": 89.3, "AGUA": 84.0, "LIMPIEZA": 93.5, ... }
  */
  const elSlaTipo = document.getElementById('g-sla-tipo');
  if (elSlaTipo && j.sla_by_type_tipo) {
    const tipos = Object.keys(j.sla_by_type_tipo || {});
    const val   = tipos.map(k => j.sla_by_type_tipo[k]);
    new Chart(elSlaTipo, {
      type: 'bar',
      data: {
        labels: tipos,
        datasets: [{ label: '% SLA', data: val, backgroundColor: ACCENT }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: { legend: { display: false } }
      }
    });
  }

  /* === Recurrentes (30d) ===
     Espera j.recurrentes como array de objetos:
     [{ tipo:"AGUA", ubicacion:"302", count:5, last_seen:"2025-10-10 12:00" }, ...]
  */
  const Trec = document.getElementById('g-recurr-tbody');
  if (Trec) {
    const rows = (j.recurrentes || []).slice(0, 12).map(r => `
      <tr>
        <td>${r.tipo || '—'}</td>
        <td>${r.ubicacion || '—'}</td>
        <td>${r.count ?? 0}</td>
        <td><small>${r.last_seen || '—'}</small></td>
      </tr>
    `).join('');
    Trec.innerHTML = rows || `<tr><td colspan="4" class="text-center text-muted py-3">Sin datos (30d)</td></tr>`;
  }


  // Open table with assigned + elapsed
  const T = document.getElementById('g-open-tbody');
  const rows = (j.open_items || []).slice(0, 30).map(t => `
    <tr class="${t.due_at && t.elapsed_min ? '' : ''}">
      <td>#${t.id}</td>
      <td>${t.area || '—'}</td>
      <td>${t.prioridad || '—'}</td>
      <td class="text-truncate" style="max-width:380px">${t.detalle || ''}</td>
      <td>${t.assigned_name || '(sin asignar)'}</td>
      <td>${t.elapsed_min != null ? (t.elapsed_min + ' min') : '—'}</td>
      <td><small>${t.due_at || '—'}</small></td>
    </tr>`).join('');
  T.innerHTML = rows || `<tr><td colspan="7" class="text-center text-muted py-3">Sin abiertos</td></tr>`;
})();
</script>

{% endblock %}
