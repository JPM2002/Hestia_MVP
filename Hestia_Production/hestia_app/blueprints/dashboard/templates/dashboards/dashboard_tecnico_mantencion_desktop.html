{% extends "base.html" %}
{% block title %}Mantenci√≥n ‚Äî Mi trabajo{% endblock %}

{% block content %}
<style>
  /* keep right column inside card on wider screens too */
  .tk-row { display:flex; justify-content:space-between; align-items:flex-start; gap:.5rem; }
  .tk-main { min-width:0; }
  .tk-detail { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height: 1.15; }
  .tk-meta { flex: 0 0 auto; max-width: 40%; text-align: right; }
  .tk-meta .small { white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height: 1.1; }
  .tk-meta .badge { display:inline-block; margin-bottom:.15rem; }

  @media (max-width: 576px) {
    .tk-meta { max-width: 46%; }
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="page-title mb-0">üõ†Ô∏è Mantenci√≥n ‚Äî Mi trabajo</h1>
    <div class="small text-muted">Vista escritorio</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-accent"
       href="{{ url_for('tickets.ticket_create') }}">Nuevo ticket</a>
    <a class="btn btn-outline-dark"
       href="{{ url_for('tickets.tickets', estado='PENDIENTE', area='MANTENCION') }}">Todos</a>
  </div>
</div>

<!-- Shift controls (same layout as HK mobile, but for desktop) -->
<section class="mb-3">
  <div class="d-flex gap-2">
    <!-- Start as outline; turns solid when activo (JS to be wired later) -->
    <button id="btn-shift-start" class="btn btn-outline-success flex-fill">Iniciar turno</button>
    <!-- Pause is outline; turns solid when pausado -->
    <button id="btn-shift-pause" class="btn btn-outline-warning flex-fill">Pausa</button>
    <button id="btn-shift-stop"  class="btn btn-outline-danger flex-fill">Cerrar turno</button>
  </div>
  <div class="small text-muted mt-1" id="shift-status">Turno: inactivo</div>
</section>

<!-- Quick Actions -->
<section class="mb-3">
  <div class="row g-2 row-cols-1 row-cols-sm-2 row-cols-lg-3">
    <div class="col">
      <a class="btn w-100 btn-light py-3 border rounded-3"
         href="{{ url_for('tecnico.tech_in_progress', slug='mantencion') }}">
        <div class="fw-semibold">En curso</div>
        <div class="small text-muted">lo que estoy haciendo</div>
      </a>
    </div>
    <div class="col">
      <a class="btn w-100 btn-light py-3 border rounded-3"
         href="{{ url_for('tecnico.tech_my', slug='mantencion') }}">
        <div class="fw-semibold">Mis asignados</div>
        <div class="small text-muted">todo lo m√≠o</div>
      </a>
    </div>
    <div class="col">
      <a class="btn w-100 btn-light py-3 border rounded-3"
         href="{{ url_for('tecnico.tech_available', slug='mantencion') }}">
        <div class="fw-semibold">Lista</div>
        <div class="small text-muted">disponibles del √°rea</div>
      </a>
    </div>
    <div class="col">
      {% if user and user.role in ['GERENTE','SUPERVISOR','RECEPCION'] %}
        <a class="btn w-100 btn-light py-3 border rounded-3"
           href="{{ url_for('tickets.ticket_create') }}">
          <div class="fw-semibold">Nuevo</div>
          <div class="small text-muted">crear ticket</div>
        </a>
      {% else %}
        <button class="btn w-100 py-3 border rounded-3" disabled>
          <div class="fw-semibold">Nuevo</div>
          <div class="small text-muted">sin permiso</div>
        </button>
      {% endif %}
    </div>
    <div class="col">
      <a class="btn w-100 btn-light py-3 border rounded-3"
         href="{{ url_for('tecnico.tech_tools', slug='mantencion') }}">
        <div class="fw-semibold">Herramientas</div>
        <div class="small text-muted">checklists y recursos</div>
      </a>
    </div>
    <div class="col">
      <a class="btn w-100 btn-light py-3 border rounded-3"
         href="{{ url_for('tecnico.tech_history', slug='mantencion', days=7) }}">
        <div class="fw-semibold">Historial</div>
        <div class="small text-muted">√∫ltimos 7 d√≠as</div>
      </a>
    </div>
  </div>
</section>

<!-- Filters -->
<div class="d-flex flex-wrap gap-2 mb-3">
  <select id="flt-prio" class="form-select form-select-sm" style="max-width: 150px">
    <option value="">Prioridad</option>
    <option>URGENTE</option>
    <option>ALTA</option>
    <option>MEDIA</option>
    <option>BAJA</option>
  </select>
  <select id="flt-estado" class="form-select form-select-sm" style="max-width: 170px">
    <option value="">Estado</option>
    <option>PENDIENTE</option>
    <option>ASIGNADO</option>
    <option>ACEPTADO</option>
    <option>EN_CURSO</option>
    <option>PAUSADO</option>
    <option>DERIVADO</option>
  </select>
  <input id="flt-q" class="form-control form-control-sm"
         placeholder="Buscar habitaci√≥n / detalle..."
         style="max-width: 260px" />
</div>

<!-- Card list of tickets (same semantics as mobile) -->
<ul id="mnt-list" class="list-unstyled d-grid gap-2">
  {% for t in (tickets or []) %}
  <li class="card {% if t.is_critical %}border-danger{% endif %}"
      data-prio="{{ t.prioridad }}"
      data-estado="{{ t.estado }}"
      data-key="{{ (t.ubicacion ~ ' ' ~ t.detalle)|lower }}">
    <div class="card-body p-2">
      <div class="tk-row">
        <div class="tk-main">
          <div class="fw-semibold">{{ t.ubicacion or 'Ubicaci√≥n' }}</div>
          <div class="small text-muted tk-detail">{{ t.detalle }}</div>
        </div>
        <div class="tk-meta">
          <span class="badge
            {% if t.prioridad=='URGENTE' %}text-bg-danger
            {% elif t.prioridad=='ALTA' %}text-bg-warning
            {% elif t.prioridad=='MEDIA' %}text-bg-primary
            {% else %}text-bg-secondary{% endif %}">
            {{ t.prioridad }}
          </span>
          {% if t.due_at %}
            <div class="small {% if t.is_critical %}text-danger fw-semibold{% else %}text-muted{% endif %}">
              SLA {{ t.due_at|short_dt }}
            </div>
          {% else %}
            <div class="small text-muted">Sin SLA</div>
          {% endif %}
        </div>
      </div>

      {% if t.due_at %}
      <div class="progress mt-2" style="height:6px">
        <div class="progress-bar {% if t.is_critical %}bg-danger{% else %}bg-success{% endif %}"
             style="width: {{ 100 if t.is_critical else 60 }}%"></div>
      </div>
      {% endif %}

      <div class="mt-2 d-flex flex-wrap gap-1">
        {% if t.estado in ['PENDIENTE','ASIGNADO'] %}
          <form method="post" action="{{ url_for('tickets.ticket_accept', id=t.id) }}">
            <button class="btn btn-sm btn-outline-primary">Aceptar</button>
          </form>
        {% endif %}

        {% if t.estado in ['ACEPTADO'] %}
          <form method="post" action="{{ url_for('tickets.ticket_start', id=t.id) }}">
            <button class="btn btn-sm btn-dark">Iniciar</button>
          </form>
          <form method="post" action="{{ url_for('tickets.ticket_pause', id=t.id) }}">
            <input type="hidden" name="motivo" value="Espera repuestos">
            <button class="btn btn-sm btn-outline-warning">Pausa</button>
          </form>
        {% endif %}

        {% if t.estado in ['EN_CURSO'] %}
          <form method="post" action="{{ url_for('tickets.ticket_pause', id=t.id) }}">
            <input type="hidden" name="motivo" value="Bloqueado">
            <button class="btn btn-sm btn-outline-warning">Pausa</button>
          </form>
          <form method="post" action="{{ url_for('tickets.ticket_finish', id=t.id) }}">
            <button class="btn btn-sm btn-success">Resolver</button>
          </form>
        {% endif %}

        {% if t.estado in ['PAUSADO'] %}
          <form method="post" action="{{ url_for('tickets.ticket_resume', id=t.id) }}">
            <button class="btn btn-sm btn-outline-secondary">Reanudar</button>
          </form>
        {% endif %}
      </div>

      <div class="mt-2 d-flex justify-content-between small text-muted">
        <span>Estado: {{ t.estado|nice_state }}</span>
        <span>Creado: {{ t.created_at|short_dt }}</span>
      </div>
    </div>
  </li>
  {% else %}
    <li class="text-center text-muted py-4">No tienes tickets asignados.</li>
  {% endfor %}
</ul>
{% endblock %}

{% block scripts %}
<script>
  const list = document.getElementById('mnt-list');
  const items = list ? Array.from(list.querySelectorAll('.card')) : [];
  const pr = document.getElementById('flt-prio');
  const st = document.getElementById('flt-estado');
  const q  = document.getElementById('flt-q');

  function applyFilters(){
    const p = pr?.value || '';
    const s = st?.value || '';
    const k = (q?.value || '').toLowerCase();

    items.forEach(li => {
      const okp = !p || li.dataset.prio === p;
      const oks = !s || li.dataset.estado === s;
      const okk = !k || (li.dataset.key || '').includes(k);
      li.style.display = (okp && oks && okk) ? '' : 'none';
    });
  }

  [pr, st, q].forEach(el => el && el.addEventListener('input', applyFilters));
</script>
{% endblock %}
