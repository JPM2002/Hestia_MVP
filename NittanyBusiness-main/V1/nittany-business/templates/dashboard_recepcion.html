{% extends "base.html" %}
{% block title %}Recepci√≥n ‚Äî Tickets{% endblock %}

{% block content %}

<style>
  .list-item-flex { display:flex; justify-content:space-between; align-items:flex-start; gap:.5rem; }
  .list-item-main { min-width:0; }
  .list-item-detail { white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
  .list-item-meta { flex:0 0 auto; max-width:34%; text-align:right; }
  .pill { display:inline-block; padding:.15rem .4rem; border-radius:.5rem; background:#f2f2f2; }
  .tiny { font-size:.8rem; }
  .btn-row { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem; }
  .pending-approval { background: #fff6e6; }  /* resalta por aprobar */
  .toolbar { gap:.5rem; }
  .toolbar .form-select, .toolbar .form-control { height: 36px; }
</style>

<header class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">üìü Recepci√≥n ‚Äî Tickets</h1>
  <div class="d-flex gap-2">
    <!-- Abre modal para ticket manual (auto-aprobado por rol recepci√≥n) -->
    <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#manualModal">Ingresar ticket manual</button>
    <a class="btn btn-outline-dark" href="{{ url_for('tickets') }}">Ver todos</a>
  </div>
</header>

<!-- Toolbar: b√∫squeda + filtros (cliente) -->
<div class="card mb-3">
  <div class="card-body d-flex flex-wrap toolbar">
    <input id="flt-q" class="form-control" placeholder="Buscar por detalle, hu√©sped, ubicaci√≥n‚Ä¶" style="min-width: 240px; flex: 1 1 320px;">
    <select id="flt-estado" class="form-select" style="width: 160px;">
      <option value="">Estado (todos)</option>
      <option value="PENDIENTE">Pendiente</option>
      <option value="EN_CURSO">En curso</option>
      <option value="RESUELTO">Resuelto hoy</option>
    </select>
    <select id="flt-prio" class="form-select" style="width: 160px;">
      <option value="">Prioridad (todas)</option>
      <option>URGENTE</option><option>ALTA</option><option>MEDIA</option><option>BAJA</option>
    </select>
    <select id="flt-area" class="form-select" style="width: 180px;">
      <option value="">√Årea (todas)</option>
      <option>MANTENCION</option><option>HOUSEKEEPING</option><option>ROOMSERVICE</option>
    </select>
    <button id="flt-clear" class="btn btn-light ms-auto">Limpiar</button>
  </div>
</div>

<!-- KPIs -->
<div class="row g-3 mb-3">
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">Por aprobar</div>
      <div id="kpi-toapprove" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">Pendientes</div>
      <div id="kpi-pending" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">En curso</div>
      <div id="kpi-inprogress" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">Resueltos (hoy)</div>
      <div id="kpi-resolved" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
</div>

<!-- Cr√≠ticos header + countdown -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">üî• Cr√≠ticos (SLA en riesgo)</h5>
  <div class="d-flex align-items-center gap-2 small text-muted">
    <span id="crit-timer">Actualizando en 10s</span>
    <span id="crit-busy" class="spinner-border spinner-border-sm" hidden></span>
  </div>
</div>
<div class="card mb-3">
  <ul id="list-critical" class="list-group list-group-flush small"></ul>
</div>

<div class="row g-3">
  <!-- Por aprobar (primero, destacado) -->
  <div class="col-12">
    <div class="card pending-approval">
      <div class="card-header py-2">üìù Por aprobar</div>
      <ul id="list-toapprove" class="list-group list-group-flush small"></ul>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <!-- Pendientes -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">üì• Pendientes</div>
      <ul id="list-pending" class="list-group list-group-flush small"></ul>
    </div>
  </div>
  <!-- En curso -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">‚è≥ En curso</div>
      <ul id="list-progress" class="list-group list-group-flush small"></ul>
    </div>
  </div>
  <!-- Resueltos (hoy) -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">‚úÖ Resueltos (hoy)</div>
      <ul id="list-resolved" class="list-group list-group-flush small"></ul>
    </div>
  </div>
</div>

<!-- Feed -->
<div class="card mt-3">
  <div class="card-header py-2">üì∞ √öltimos movimientos</div>
  <ul id="feed" class="list-group list-group-flush small"></ul>
</div>

<!-- Ding -->
<audio id="ding" preload="auto">
  <source src="{{ url_for('static', filename='snd/new-ticket.mp3') }}" type="audio/mpeg">
</audio>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar ticket <span id="edit-id" class="text-muted"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="ticket_id" id="edit-ticket-id">
        <div class="mb-2">
          <label class="form-label">Detalle</label>
          <textarea name="detalle" id="edit-detalle" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Prioridad</label>
          <select name="prioridad" id="edit-prioridad" class="form-select">
            <option value="">‚Äî</option>
            <option>URGENTE</option><option>ALTA</option><option>MEDIA</option><option>BAJA</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Ubicaci√≥n</label>
          <input name="ubicacion" id="edit-ubicacion" class="form-control" />
        </div>
        <div class="small text-muted">Se registrar√° en el historial.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete (soft) Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="deleteForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Eliminar ticket <span id="del-id" class="text-muted"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="delete-ticket-id" name="ticket_id">
        <label class="form-label">Motivo</label>
        <textarea name="motivo" id="delete-motivo" class="form-control" rows="3" placeholder="Ej: ticket duplicado / creado por error"></textarea>
        <div class="small text-muted mt-1">Se registrar√° como baja l√≥gica (soft delete).</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-danger" type="submit">Eliminar</button>
      </div>
    </form>
  </div>
</div>

<!-- Ticket manual (auto-aprobado por recepci√≥n) -->
<div class="modal fade" id="manualModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="manualForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ingresar ticket manual</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- TODO backend: aceptar approved=true y created_by_role='RECEPCION' para auto-omitir aprobaci√≥n -->
        <div class="mb-2">
          <label class="form-label">√Årea</label>
          <select name="area" class="form-select" required>
            <option value="">‚Äî</option>
            <option>MANTENCION</option><option>HOUSEKEEPING</option><option>ROOMSERVICE</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Prioridad</label>
          <select name="prioridad" class="form-select" required>
            <option>MEDIA</option><option>URGENTE</option><option>ALTA</option><option>BAJA</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Detalle</label>
          <textarea name="detalle" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Ubicaci√≥n</label>
          <input name="ubicacion" class="form-control" placeholder="Ej: 302" />
        </div>
        <div class="mb-2">
          <label class="form-label">Hu√©sped (opcional)</label>
          <input name="guest_name" class="form-control" placeholder="Nombre del hu√©sped" />
          <input name="guest_id" class="form-control mt-1" placeholder="ID / PMS" />
        </div>
        <input type="hidden" name="approved" value="true">
        <input type="hidden" name="created_by_role" value="RECEPCION">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Crear</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
// RBAC flags (puedes renderizarlas desde servidor)
const CAN_EDIT = true;
const CAN_APPROVE = true;
const CAN_DELETE = false;

// --- Modales ---
let editModal, editForm, deleteModal, deleteForm, manualModal, manualForm;

window.addEventListener('DOMContentLoaded', () => {
  editModal   = new bootstrap.Modal(document.getElementById('editModal'));
  editForm    = document.getElementById('editForm');
  deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  deleteForm  = document.getElementById('deleteForm');
  manualModal = new bootstrap.Modal(document.getElementById('manualModal'));
  manualForm  = document.getElementById('manualForm');

  editForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('edit-ticket-id').value;
    const fd = new FormData(editForm);
    const r = await fetch(`/tickets/${id}/edit`, { method:'POST', body: fd });
    if (r.ok) { editModal.hide(); await window.refreshAll?.(); } else { alert('No se pudo guardar.'); }
  });

  deleteForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('delete-ticket-id').value;
    const fd = new FormData(deleteForm);
    const r = await fetch(`/tickets/${id}/delete`, { method:'POST', body: fd });
    if (r.ok) { deleteModal.hide(); await window.refreshAll?.(); } else { alert('No se pudo eliminar.'); }
  });

  manualForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(manualForm);
    // TODO: si creas /tickets/manual usa esa URL; por ahora reusa el create general.
    const r = await fetch(`/tickets/create`, { method:'POST', body: fd });
    if (r.ok) { manualModal.hide(); await window.refreshAll?.(); } else { alert('No se pudo crear el ticket.'); }
  });

  // Filtros UI
  const inputs = ['flt-q','flt-estado','flt-prio','flt-area'].map(id=>document.getElementById(id));
  inputs.forEach(i => i.addEventListener('input', () => renderFromCache()));
  document.getElementById('flt-clear').addEventListener('click', () => {
    document.getElementById('flt-q').value = '';
    document.getElementById('flt-estado').value = '';
    document.getElementById('flt-prio').value = '';
    document.getElementById('flt-area').value = '';
    renderFromCache();
  });
});

window.openEdit = (t) => {
  document.getElementById('edit-id').textContent = `#${t.id}`;
  document.getElementById('edit-ticket-id').value = t.id;
  document.getElementById('edit-detalle').value = t.detalle || '';
  document.getElementById('edit-prioridad').value = (t.prioridad || '').toUpperCase();
  document.getElementById('edit-ubicacion').value = t.ubicacion || '';
  editModal.show();
};

window.openDelete = (id) => {
  document.getElementById('del-id').textContent = `#${id}`;
  document.getElementById('delete-ticket-id').value = id;
  document.getElementById('delete-motivo').value = '';
  deleteModal.show();
};

window.approveTicket = async (id) => {
  const r = await fetch(`/tickets/${id}/confirm`, { method:'POST' });
  if (r.ok) { await window.refreshAll?.(); } else { alert('No se pudo aprobar.'); }
};
</script>

<script>
/* ===== Countdown + refresh hook for Cr√≠ticos ===== */
(function () {
  const EVERY = 10;
  let secs = EVERY;
  const label = document.getElementById('crit-timer');
  const busy  = document.getElementById('crit-busy');

  async function refreshCriticos() {
    try {
      if (busy) busy.hidden = false;
      if (window.loadCriticos) { await window.loadCriticos(); }
      else if (window.refreshAll) { await window.refreshAll(); }
      else { await new Promise(r => setTimeout(r, 300)); }
    } finally {
      if (busy) busy.hidden = true;
      secs = EVERY;
      if (label) {
        label.textContent = 'Actualizado';
        setTimeout(() => { label.textContent = `Actualizando en ${secs}s`; }, 800);
      }
    }
  }

  setInterval(() => {
    secs -= 1;
    if (secs <= 0) { refreshCriticos(); }
    else if (label) { label.textContent = `Actualizando en ${secs}s`; }
  }, 1000);

  window.resetCritTimer = () => { secs = EVERY; if (label) label.textContent = `Actualizando en ${secs}s`; };
})();
</script>

<script>
/* ===== Datos + render con filtros ===== */
const el = {
  kpiToApprove: document.getElementById('kpi-toapprove'),
  kpiPending:  document.getElementById('kpi-pending'),
  kpiInProg:   document.getElementById('kpi-inprogress'),
  kpiResolved: document.getElementById('kpi-resolved'),
  listCrit:    document.getElementById('list-critical'),
  listToAppr:  document.getElementById('list-toapprove'),
  listPend:    document.getElementById('list-pending'),
  listProg:    document.getElementById('list-progress'),
  listRes:     document.getElementById('list-resolved'),
  feed:        document.getElementById('feed'),
  ding:        document.getElementById('ding'),
};

let cache = { toapprove: [], pending: [], progress: [], resolved: [] };
let prev = { pendingIds: new Set() };

function pill(text){ return `<span class="pill tiny">${text}</span>`; }

function metaAssigned(t){
  const who = t.assigned_name || '(sin asignar)';
  const due = t.due_at ? `Vence ${t.due_at}` : 'Sin SLA';
  const crit = t.is_critical ? ` <span class="text-danger fw-semibold">‚ö†</span>` : '';
  return `${pill('Asignado: ' + who)}<br><span class="text-muted">${due}${crit}</span>`;
}

function headerWithGuest(t){
  const priClass = t.prioridad==='URGENTE' ? 'text-bg-danger' :
                   t.prioridad==='ALTA'    ? 'text-bg-warning' :
                   t.prioridad==='MEDIA'   ? 'text-bg-primary' : 'text-bg-secondary';
  const room = t.ubicacion ? ` ¬∑ ${t.ubicacion}` : '';
  const guest = (t.guest_name || t.huesped || '') ? ` ¬∑ Hu√©sped: ${(t.guest_name || t.huesped || '')}${t.guest_id ? ' ('+t.guest_id+')':''}` : '';
  return `<div class="d-flex align-items-center flex-wrap gap-1">
            <span class="badge ${priClass} me-1">${t.prioridad || '‚Äî'}</span>
            <span>${t.area || '‚Äî'}${room}${guest}</span>
          </div>`;
}

function actionButtonsPending(t){
  // ‚ÄúPor aprobar‚Äù = pendiente + ingresado por WhatsApp hu√©sped
  const isAwaiting = (t.estado === 'PENDIENTE') && ((t.canal || '').toLowerCase() === 'huesped_whatsapp');

  const editBtn = CAN_EDIT
    ? `<button class="btn btn-sm btn-outline-secondary" onclick='openEdit(${JSON.stringify(t)})'>Editar</button>`
    : '';

  const approveBtn = (CAN_APPROVE && isAwaiting)
    ? `<button class="btn btn-sm btn-success" onclick="approveTicket(${t.id})">Aprobar</button>`
    : '';

  // Delete is disabled (no live endpoint)
  const deleteBtn  = '';

  return `<div class="btn-row">${approveBtn}${deleteBtn}${editBtn}</div>`;
}


function liTicketPending(t){
  return `<li class="list-group-item">
    <div class="list-item-flex">
      <div class="list-item-main">
        ${headerWithGuest(t)}
        <div class="text-muted list-item-detail">${t.detalle || ''}</div>
        ${actionButtonsPending(t)}
      </div>
      <div class="list-item-meta small">${metaAssigned(t)}</div>
    </div>
  </li>`;
}

function liTicketGeneric(t){
  return `<li class="list-group-item">
    <div class="list-item-flex">
      <div class="list-item-main">
        ${headerWithGuest(t)}
        <div class="text-muted list-item-detail">${t.detalle || ''}</div>
        ${CAN_EDIT ? `<div class="btn-row"><button class="btn btn-sm btn-outline-secondary" onclick='openEdit(${JSON.stringify(t)})'>Editar</button></div>` : ''}
      </div>
      <div class="list-item-meta small">${metaAssigned(t)}</div>
    </div>
  </li>`;
}

function liFeed(x){
  const who = x.actor || 'sistema';
  const room = x.ubicacion ? ` ¬∑ ${x.ubicacion}` : '';
  return `<li class="list-group-item">
    <span class="text-muted">${x.at}</span> ‚Äî Ticket #${x.ticket_id} ${x.action} por ${who} (${x.area || '‚Äî'}${room})
    ${x.motivo ? ` ¬∑ <span class="text-muted">${x.motivo}</span>` : ''}
  </li>`;
}

async function loadKPIs(){
  const [k, pend] = await Promise.all([
    fetch('/api/recepcion/kpis'),
    fetch('/api/recepcion/list?estado=PENDIENTE&period=today&limit=500')
  ]);

  if(k.ok){
    const j = await k.json();
    el.kpiPending.textContent   = j.pending ?? '0';
    el.kpiInProg.textContent    = j.in_progress ?? '0';
    el.kpiResolved.textContent  = j.resolved_today ?? '0';
  }

  // Compute ‚ÄúPor aprobar‚Äù client-side: pendientes de hu√©sped WhatsApp
  if(pend.ok){
    const jp = await pend.json();
    const toApproveCount = (jp.items || []).filter(x => (x.canal || '').toLowerCase() === 'huesped_whatsapp').length;
    el.kpiToApprove.textContent = String(toApproveCount);
  }
}


async function loadLists(){
  const [p, e, r] = await Promise.all([
    fetch('/api/recepcion/list?estado=PENDIENTE&period=today&limit=300'),
    fetch('/api/recepcion/list?estado=EN_CURSO&period=7d&limit=300'),
    fetch('/api/recepcion/list?estado=RESUELTO&period=today&limit=300'),
  ]);
  const jp = p.ok ? await p.json() : {items:[]};
  const je = e.ok ? await e.json() : {items:[]};
  const jr = r.ok ? await r.json() : {items:[]};

  // Divide PENDIENTES entre por aprobar vs pendientes ya aprobados
  // ‚ÄúPor aprobar‚Äù = pendientes ingresados por hu√©sped (WhatsApp)
  const toapprove = (jp.items||[]).filter(x => (x.canal || '').toLowerCase() === 'huesped_whatsapp');
  const pend      = (jp.items||[]).filter(x => (x.canal || '').toLowerCase() !== 'huesped_whatsapp');


  cache = {
    toapprove,
    pending: pend,
    progress: (je.items||[]),
    resolved: (jr.items||[])
  };

  // Ding si crecen los pendientes (no-aprobados no disparan ding)
  const ids = new Set(pend.map(x=>x.id));
  const newId = [...ids].find(id => !prev.pendingIds.has(id));
  if ((ids.size > prev.pendingIds.size || newId) && el.ding) {
    try { el.ding.currentTime = 0; el.ding.play().catch(()=>{}); } catch(e){}
  }
  prev.pendingIds = ids;

  renderFromCache();
}

function applyFilters(list, forceEstado=''){
  const q = (document.getElementById('flt-q').value || '').toLowerCase();
  const estado = forceEstado || (document.getElementById('flt-estado').value || '');
  const prio   = (document.getElementById('flt-prio').value || '');
  const area   = (document.getElementById('flt-area').value || '');

  return (list||[]).filter(t => {
    if (estado && !((t.estado||'').includes(estado))) return false;
    if (prio && (t.prioridad||'') !== prio) return false;
    if (area && (t.area||'') !== area) return false;
    if (q) {
      const hay = `${t.detalle||''} ${t.guest_name||''} ${t.guest_id||''} ${t.ubicacion||''}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });
}

function renderFromCache(){
  // Cr√≠ticos (mezcla de por aprobar NO; solo pendientes aprobados + en curso)
  const criticalItems = [...cache.pending, ...cache.progress].filter(x=>x.is_critical);
  el.listCrit.innerHTML = criticalItems.slice(0,8).map(liTicketGeneric).join('') ||
                          '<li class="list-group-item text-muted">Sin cr√≠ticos</li>';

  // Por aprobar
  const TA = applyFilters(cache.toapprove, 'PENDIENTE');
  el.listToAppr.innerHTML = TA.map(liTicketPending).join('') ||
                            '<li class="list-group-item text-muted">Sin items</li>';

  // Pendientes
  const P = applyFilters(cache.pending, 'PENDIENTE');
  el.listPend.innerHTML = P.map(liTicketGeneric).join('') ||
                          '<li class="list-group-item text-muted">Vac√≠o</li>';

  // En curso
  const E = applyFilters(cache.progress, 'EN_CURSO'); // filtro l√≥gico por estado seleccionado
  el.listProg.innerHTML = E.map(liTicketGeneric).join('') ||
                          '<li class="list-group-item text-muted">Vac√≠o</li>';

  // Resueltos hoy
  const R = applyFilters(cache.resolved, 'RESUELTO');
  el.listRes.innerHTML = R.map(liTicketGeneric).join('') ||
                         '<li class="list-group-item text-muted">Vac√≠o</li>';
}

async function loadFeed(){
  const r = await fetch('/api/feed/recent');
  if(!r.ok) return;
  const j = await r.json();
  el.feed.innerHTML = (j.items||[]).map(liFeed).join('') || '<li class="list-group-item text-muted">Sin movimientos</li>';
}

// expose helpers
window.loadCriticos = async () => { await loadLists(); };
window.refreshAll   = async () => { await loadKPIs(); await loadLists(); await loadFeed(); };

function tick(){
  loadKPIs();
  loadLists().then(()=> window.resetCritTimer && window.resetCritTimer());
  loadFeed();
}

tick();
setInterval(tick, 8000);
</script>
{% endblock %}
