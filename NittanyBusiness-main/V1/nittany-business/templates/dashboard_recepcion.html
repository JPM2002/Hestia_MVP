{% extends "base.html" %}
{% block title %}Recepci√≥n ‚Äî Dashboard{% endblock %}

{% block content %}

<style>
  /* safe wrapping inside the two-column row for each ticket */
  .list-item-flex { display:flex; justify-content:space-between; align-items:flex-start; gap:.5rem; }
  .list-item-main { min-width:0; } /* critical for wrapping within flex */
  .list-item-detail { white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
  .list-item-meta { flex:0 0 auto; max-width:30%; }
</style>

<header class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">üìü Recepci√≥n</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-accent" href="{{ url_for('ticket_create') }}">Nuevo ticket</a>
    <a class="btn btn-outline-dark" href="{{ url_for('tickets') }}">Ver todos</a>
  </div>
</header>

<!-- KPIs -->
<div class="row g-3 mb-3">
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">Pendientes</div>
      <div id="kpi-pending" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">En curso</div>
      <div id="kpi-inprogress" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card"><div class="card-body">
      <div class="text-muted">Resueltos (hoy)</div>
      <div id="kpi-resolved" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-danger"><div class="card-body">
      <div class="text-danger">Cr√≠ticos</div>
      <div id="kpi-critical" class="h3 mb-0">‚Äî</div>
    </div></div>
  </div>
</div>

<!-- Cr√≠ticos header + countdown -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">üî• Cr√≠ticos (pendientes/en curso con SLA en riesgo)</h5>
  <div class="d-flex align-items-center gap-2 small text-muted">
    <span id="crit-timer">Actualizando en 10s</span>
    <span id="crit-busy" class="spinner-border spinner-border-sm" hidden></span>
  </div>
</div>
<!-- Cr√≠ticos list (the JS writes into #list-critical) -->
<div class="card mb-3">
  <ul id="list-critical" class="list-group list-group-flush small"></ul>
</div>

<div class="row g-3">
  <!-- Pendientes -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">üì• Pendientes</div>
      <ul id="list-pending" class="list-group list-group-flush small"></ul>
    </div>
  </div>
  <!-- En curso -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">‚è≥ En curso</div>
      <ul id="list-progress" class="list-group list-group-flush small"></ul>
    </div>
  </div>
  <!-- Resueltos (hoy) -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header py-2">‚úÖ Resueltos (hoy)</div>
      <ul id="list-resolved" class="list-group list-group-flush small"></ul>
    </div>
  </div>
</div>

<!-- Feed -->
<div class="card mt-3">
  <div class="card-header py-2">üì∞ √öltimos movimientos</div>
  <ul id="feed" class="list-group list-group-flush small"></ul>
</div>

<!-- Ding -->
<audio id="ding" preload="auto">
  <source src="{{ url_for('static', filename='snd/new-ticket.mp3') }}" type="audio/mpeg">
</audio>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar ticket <span id="edit-id" class="text-muted"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="ticket_id" id="edit-ticket-id">
        <div class="mb-2">
          <label class="form-label">Detalle</label>
          <textarea name="detalle" id="edit-detalle" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Prioridad</label>
          <select name="prioridad" id="edit-prioridad" class="form-select">
            <option value="">‚Äî</option>
            <option>URGENTE</option>
            <option>ALTA</option>
            <option>MEDIA</option>
            <option>BAJA</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Ubicaci√≥n</label>
          <input name="ubicacion" id="edit-ubicacion" class="form-control" />
        </div>
        <div class="small text-muted">Se registrar√° en el historial.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
// Allow edit from list items
const CAN_EDIT = true; // flip by RBAC on server if you want

function liTicket(t){
  const priClass = t.prioridad==='URGENTE' ? 'text-bg-danger' :
                   t.prioridad==='ALTA'    ? 'text-bg-warning' :
                   t.prioridad==='MEDIA'   ? 'text-bg-primary' : 'text-bg-secondary';
  const room = t.ubicacion ? ` ¬∑ ${t.ubicacion}` : '';
  const sla  = t.is_critical ? `<span class="text-danger fw-semibold"> ‚ö†</span>` : '';
  const editBtn = CAN_EDIT ? `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="openEdit(${t.id}, ${JSON.stringify((t.detalle||'')).replace(/"/g,'&quot;')}, '${t.prioridad||''}', '${(t.ubicacion||'').replace(/'/g,"&#39;")}')">Editar</button>` : '';

  return `<li class="list-group-item">
    <div class="list-item-flex">
      <div class="list-item-main">
        <div class="d-flex align-items-center">
          <span class="badge ${priClass} me-1">${t.prioridad || '‚Äî'}</span>${t.area || '‚Äî'}${room}
          ${editBtn}
        </div>
        <div class="text-muted list-item-detail">${t.detalle || ''}</div>
      </div>
      <div class="text-end small text-muted list-item-meta">
        ${t.estado || ''}${sla}<br>
        <span>${t.due_at ? ('Vence ' + t.due_at) : 'Sin SLA'}</span>
      </div>
    </div>
  </li>`;
}

// Edit modal handlers
let editModal, editForm;
window.addEventListener('DOMContentLoaded', () => {
  editModal = new bootstrap.Modal(document.getElementById('editModal'));
  editForm  = document.getElementById('editForm');

  editForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('edit-ticket-id').value;
    const fd = new FormData(editForm);
    const r = await fetch(`/tickets/${id}/edit`, { method:'POST', body: fd });
    if (r.ok) {
      editModal.hide();
      // refresh lists/kpis/feed
      await window.refreshAll?.();
    } else {
      alert('No se pudo guardar.');
    }
  });
});

window.openEdit = (id, detalle, prioridad, ubicacion) => {
  document.getElementById('edit-id').textContent = `#${id}`;
  document.getElementById('edit-ticket-id').value = id;
  document.getElementById('edit-detalle').value = detalle || '';
  document.getElementById('edit-prioridad').value = (prioridad || '').toUpperCase();
  document.getElementById('edit-ubicacion').value = ubicacion || '';
  editModal.show();
};
</script>


<script>
/* ===== Countdown + refresh hook for Cr√≠ticos ===== */
(function () {
  const EVERY = 10;  // seconds
  let secs = EVERY;
  const label = document.getElementById('crit-timer');
  const busy  = document.getElementById('crit-busy');

  async function refreshCriticos() {
    try {
      if (busy) busy.hidden = false;
      if (window.loadCriticos) {
        await window.loadCriticos();
      } else if (window.refreshAll) {
        await window.refreshAll();
      } else {
        await new Promise(r => setTimeout(r, 300));
      }
    } finally {
      if (busy) busy.hidden = true;
      secs = EVERY;
      if (label) {
        label.textContent = 'Actualizado';
        setTimeout(() => { label.textContent = `Actualizando en ${secs}s`; }, 800);
      }
    }
  }

  setInterval(() => {
    secs -= 1;
    if (secs <= 0) {
      refreshCriticos();
    } else if (label) {
      label.textContent = `Actualizando en ${secs}s`;
    }
  }, 1000);

  // allow data loaders to reset the countdown when they finish
  window.resetCritTimer = () => { secs = EVERY; if (label) label.textContent = `Actualizando en ${secs}s`; };
})();
</script>

<script>
/* ===== Dashboard data + rendering ===== */
const el = {
  kpiPending:  document.getElementById('kpi-pending'),
  kpiInProg:   document.getElementById('kpi-inprogress'),
  kpiResolved: document.getElementById('kpi-resolved'),
  kpiCritical: document.getElementById('kpi-critical'),
  listCrit:    document.getElementById('list-critical'),
  listPend:    document.getElementById('list-pending'),
  listProg:    document.getElementById('list-progress'),
  listRes:     document.getElementById('list-resolved'),
  feed:        document.getElementById('feed'),
  ding:        document.getElementById('ding'),
};

let prev = {
  pendingIds: new Set(),
};

function liTicket(t){
  const priClass = t.prioridad==='URGENTE' ? 'text-bg-danger' :
                   t.prioridad==='ALTA'    ? 'text-bg-warning' :
                   t.prioridad==='MEDIA'   ? 'text-bg-primary' : 'text-bg-secondary';
  const room = t.ubicacion ? ` ¬∑ ${t.ubicacion}` : '';
  const sla  = t.is_critical ? `<span class="text-danger fw-semibold"> ‚ö†</span>` : '';

  return `<li class="list-group-item">
    <div class="list-item-flex">
      <div class="list-item-main">
        <div>
          <span class="badge ${priClass} me-1">${t.prioridad || '‚Äî'}</span>${t.area || '‚Äî'}${room}
        </div>
        <div class="text-muted list-item-detail">${t.detalle || ''}</div>
      </div>
      <div class="text-end small text-muted list-item-meta">
        ${t.estado || ''}${sla}<br>
        <span>${t.due_at ? ('Vence ' + t.due_at) : 'Sin SLA'}</span>
      </div>
    </div>
  </li>`;
}

function liFeed(x){
  const who = x.actor || 'sistema';
  const room = x.ubicacion ? ` ¬∑ ${x.ubicacion}` : '';
  return `<li class="list-group-item">
    <span class="text-muted">${x.at}</span> ‚Äî Ticket #${x.ticket_id} ${x.action} por ${who} (${x.area || '‚Äî'}${room})
    ${x.motivo ? ` ¬∑ <span class="text-muted">${x.motivo}</span>` : ''}
  </li>`;
}

async function loadKPIs(){
  const r = await fetch('/api/recepcion/kpis');
  if(!r.ok) return;
  const j = await r.json();
  el.kpiPending.textContent  = j.pending ?? '0';
  el.kpiInProg.textContent   = j.in_progress ?? '0';
  el.kpiResolved.textContent = j.resolved_today ?? '0';
  el.kpiCritical.textContent = j.critical ?? '0';
}

async function loadLists(){
  const [p, e, r] = await Promise.all([
    fetch('/api/recepcion/list?estado=PENDIENTE&period=today&limit=100'),
    fetch('/api/recepcion/list?estado=EN_CURSO&period=7d&limit=100'),
    fetch('/api/recepcion/list?estado=RESUELTO&period=today&limit=100'),
  ]);
  const jp = p.ok ? await p.json() : {items:[]};
  const je = e.ok ? await e.json() : {items:[]};
  const jr = r.ok ? await r.json() : {items:[]};

  // Critical = pending + in-progress where is_critical
  if (el.listCrit) {
    const criticalItems = [...(jp.items||[]), ...(je.items||[])].filter(x=>x.is_critical);
    el.listCrit.innerHTML = criticalItems.slice(0,8).map(liTicket).join('') ||
                            '<li class="list-group-item text-muted">Sin cr√≠ticos</li>';
  }

  // Pending + ding on growth or new id
  const ids = new Set((jp.items||[]).map(x=>x.id));
  const newId = [...ids].find(id => !prev.pendingIds.has(id));
  if ((ids.size > prev.pendingIds.size || newId) && el.ding) {
    try { el.ding.currentTime = 0; el.ding.play().catch(()=>{}); } catch(e){}
  }
  prev.pendingIds = ids;
  el.listPend.innerHTML = (jp.items||[]).map(liTicket).join('') || '<li class="list-group-item text-muted">Vac√≠o</li>';

  // En curso
  el.listProg.innerHTML = (je.items||[]).map(liTicket).join('') || '<li class="list-group-item text-muted">Vac√≠o</li>';

  // Resueltos
  el.listRes.innerHTML = (jr.items||[]).map(liTicket).join('') || '<li class="list-group-item text-muted">Vac√≠o</li>';
}

async function loadFeed(){
  const r = await fetch('/api/feed/recent');
  if(!r.ok) return;
  const j = await r.json();
  el.feed.innerHTML = (j.items||[]).map(liFeed).join('') || '<li class="list-group-item text-muted">Sin movimientos</li>';
}

// expose helpers so the countdown can call them
window.loadCriticos = async () => { await loadLists(); };
window.refreshAll   = async () => { await loadKPIs(); await loadLists(); await loadFeed(); };

function tick(){
  loadKPIs();
  loadLists().then(()=> window.resetCritTimer && window.resetCritTimer());
  loadFeed();
}

tick();
setInterval(tick, 8000); // 8s
</script>
{% endblock %}
