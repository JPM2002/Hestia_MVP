<!-- templates/dashboard_recepcion.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recepción · Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Minimal, dependency-free styles -->
  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --muted:#8b94a7;
      --text:#e9eef7;
      --ok:#2ecc71;
      --warn:#f39c12;
      --bad:#e74c3c;
      --chip:#232838;
      --border:#2a3042;
      --accent:#4f8cff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      background:linear-gradient(180deg,#0f1115 0%, #0d1016 100%);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(15,17,21,.85); backdrop-filter:saturate(1.2) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .wrap{
      max-width:1200px; margin:0 auto; padding:16px;
    }
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .grow{flex:1 1 0}
    .logo{
      font-weight:800; letter-spacing:.3px; font-size:18px
    }
    .user{
      margin-left:auto; color:var(--muted); font-size:14px
    }

    /* KPIs */
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:16px}
    .kpi{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
      display:flex; flex-direction:column; gap:6px;
      min-height:86px;
    }
    .kpi h4{margin:0; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em}
    .kpi .val{font-size:28px; font-weight:750}
    .kpi.ok .val{color:var(--ok)}
    .kpi.warn .val{color:var(--warn)}
    .kpi.bad .val{color:var(--bad)}

    /* Filters + actions */
    .filters{
      margin-top:18px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center
    }
    .filters label{font-size:12px; color:var(--muted); margin-right:6px}
    .filters select,.filters input[type="number"]{
      background:#0e1320; border:1px solid var(--border); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:14px; outline:none
    }
    .btn{
      background:var(--accent); color:white; border:none;
      padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer
    }
    .btn.secondary{ background:#28304a; }
    .btn.ghost{ background:transparent; border:1px solid var(--border); color:var(--text); }
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Layout: table + feed side */
    .grid{
      display:grid; grid-template-columns: 1fr 320px; gap:16px; margin-top:16px
    }
    @media (max-width: 1000px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .grid{grid-template-columns:1fr}
    }

    /* Table */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .card h3{
      margin:0; padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em
    }
    table{width:100%; border-collapse:collapse}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap
    }
    tbody td{
      padding:10px 12px; border-bottom:1px dashed #20263a; vertical-align:top; font-size:14px
    }
    tr:hover{background:#111524}
    tr.critical{background: linear-gradient(90deg, rgba(231,76,60,0.08), transparent)}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{
      background:var(--chip); border:1px solid var(--border);
      padding:3px 8px; border-radius:100px; font-size:12px; color:#c8d2ea
    }
    .prio-URGENTE{border-color:#ff7675; color:#ffb3b3}
    .prio-ALTA{border-color:#f39c12; color:#ffd38f}
    .prio-MEDIA{border-color:#3498db; color:#b9d9ff}
    .prio-BAJA{border-color:#58d68d; color:#c8f3dc}
    .estado-PENDIENTE,.estado-PENDIENTE_APROBACION{color:#ffd38f}
    .estado-EN_CURSO{color:#b9d9ff}
    .estado-RESUELTO{color:#c8f3dc}

    /* Feed */
    .feed{display:flex; flex-direction:column; gap:10px; padding:12px}
    .feed-item{
      background: #101525; border:1px solid var(--border);
      border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:6px
    }
    .feed-item .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px}
    .pill{padding:2px 8px; border-radius:999px; background:#1a2033; border:1px solid var(--border); font-size:11px}
    .danger{color:#ffb3b3}
    .subtle{color:var(--muted)}

    /* Utilities */
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .flex{display:flex; align-items:center; gap:8px}
    .hidden{display:none}
    .nowrap{white-space:nowrap}
    .w-100{width:100%}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="logo">Hestia · Recepción</div>
      <div class="user">Sesión: <strong>{{ (user.name if user and user.name) or (user.email if user) or '—' }}</strong></div>
    </div>
  </header>

  <main class="wrap">
    <!-- KPIs -->
    <section class="kpis" id="kpi-cards">
      <div class="kpi warn">
        <h4>Pendientes</h4>
        <div class="val" id="kpi-pending">—</div>
        <div class="muted">A la espera de confirmación/asignación</div>
      </div>
      <div class="kpi">
        <h4>En curso</h4>
        <div class="val" id="kpi-inprog">—</div>
        <div class="muted">Trabajándose en este momento</div>
      </div>
      <div class="kpi ok">
        <h4>Resueltos hoy</h4>
        <div class="val" id="kpi-today">—</div>
        <div class="muted">Finalizados desde las 00:00</div>
      </div>
      <div class="kpi bad">
        <h4>Críticos</h4>
        <div class="val" id="kpi-critical">—</div>
        <div class="muted">Vencidos o a &le; 10 min del vencimiento</div>
      </div>
    </section>

    <!-- Filters -->
    <section class="filters">
      <div class="flex">
        <label for="f-estado">Estado</label>
        <select id="f-estado">
          <option value="PENDIENTE">Pendiente</option>
          <option value="EN_CURSO">En curso</option>
          <option value="RESUELTO">Resuelto</option>
          <option value="">(Todos)</option>
        </select>
      </div>
      <div class="flex">
        <label for="f-periodo">Periodo</label>
        <select id="f-periodo">
          <option value="today">Hoy</option>
          <option value="yesterday">Ayer</option>
          <option value="7d">Últimos 7 días</option>
          <option value="30d">Últimos 30 días</option>
          <option value="all">Todos</option>
        </select>
      </div>
      <div class="flex">
        <label for="f-limit">Límite</label>
        <input id="f-limit" type="number" min="10" step="10" value="100" />
      </div>

      <button class="btn" id="btn-apply">Aplicar</button>
      <button class="btn ghost" id="btn-reset">Reset</button>

      <div class="right flex">
        <label for="f-autorefresh">Autorefresco</label>
        <select id="f-autorefresh" title="Intervalo de autorefresco">
          <option value="0">Off</option>
          <option value="10">10s</option>
          <option value="20" selected>20s</option>
          <option value="30">30s</option>
          <option value="60">60s</option>
        </select>
        <button class="btn secondary" id="btn-refresh">Refrescar</button>
      </div>
    </section>

    <!-- Table + Feed -->
    <section class="grid">
      <!-- Tickets -->
      <div class="card">
        <h3 class="flex">
          Bandeja de tickets
          <span class="pill" id="list-count">—</span>
          <span class="right muted" id="list-updated">—</span>
        </h3>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th class="nowrap">ID</th>
                <th>Área</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Detalle</th>
                <th>Ubicación</th>
                <th class="nowrap">Creado</th>
                <th class="nowrap">Vence</th>
                <th>Canal</th>
                <th class="nowrap">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="10" class="muted" style="padding:18px">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Feed -->
      <aside class="card">
        <h3>Actividad reciente</h3>
        <div class="feed" id="feed">
          <div class="muted">Cargando…</div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    // ----------------------- Utilities -----------------------
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const fmt = (x) => (x ?? '—');
    const nowStr = () => new Date().toLocaleTimeString();

    function chip(text, extraClass=''){
      const span = document.createElement('span');
      span.className = `chip ${extraClass}`.trim();
      span.textContent = text ?? '—';
      return span;
    }

    function formConfirmButton(id, estado) {
      const eligible = (estado === 'PENDIENTE' || estado === 'PENDIENTE_APROBACION');
      if (!eligible) return '';
      return `
        <form method="POST" action="/tickets/${id}/confirm" style="display:inline">
          <button class="btn" style="padding:6px 10px; font-size:12px">Confirmar</button>
        </form>
      `;
    }

    // ----------------------- Data fetchers -----------------------
    async function fetchKPIs(){
      const r = await fetch('/api/recepcion/kpis', {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('kpis failed');
      const j = await r.json();
      $('#kpi-pending').textContent = j.pending ?? 0;
      $('#kpi-inprog').textContent = j.in_progress ?? 0;
      $('#kpi-today').textContent  = j.resolved_today ?? 0;
      $('#kpi-critical').textContent = j.critical ?? 0;
    }

    function currentFilters(){
      return {
        estado: $('#f-estado').value,
        period: $('#f-periodo').value,
        limit:  parseInt($('#f-limit').value || '100', 10)
      };
    }

    function qsFrom(obj){
      const params = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{
        if(v !== undefined && v !== null && v !== '') params.set(k, v);
      });
      return params.toString();
    }

    async function fetchList(){
      const q = qsFrom(currentFilters());
      const r = await fetch('/api/recepcion/list?' + q, {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('list failed');
      const j = await r.json();
      renderList(j.items || []);
      $('#list-count').textContent = (j.count ?? 0) + ' ítems';
      $('#list-updated').textContent = 'Actualizado ' + nowStr();
    }

    async function fetchFeed(){
      const r = await fetch('/api/feed/recent', {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('feed failed');
      const j = await r.json();
      renderFeed(j.items || []);
    }

    // ----------------------- Renderers -----------------------
    function renderList(items){
      const tb = $('#tbody');
      tb.innerHTML = '';
      if(!items.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="10" class="muted" style="padding:18px">No hay tickets para los filtros actuales.</td>`;
        tb.appendChild(tr);
        return;
      }

      for(const it of items){
        const tr = document.createElement('tr');
        if(it.is_critical) tr.classList.add('critical');

        const prio = chip(it.prioridad || '—', 'prio-' + (it.prioridad || '').toUpperCase());
        const est  = chip(it.estado || '—', 'estado-' + (it.estado || '').toUpperCase());

        const acciones = `
          <div class="chips">
            <a class="btn ghost" style="padding:6px 10px; font-size:12px"
               href="/tickets?q=${encodeURIComponent('#'+it.id)}" title="Abrir en Tickets">Abrir</a>
            ${formConfirmButton(it.id, (it.estado || '').toUpperCase())}
          </div>`;

        tr.innerHTML = `
          <td class="mono nowrap">#${it.id}</td>
          <td>${fmt(it.area)}</td>
          <td></td>
          <td></td>
          <td>${fmt(it.detalle)}</td>
          <td>${fmt(it.ubicacion)}</td>
          <td class="mono nowrap">${fmt(it.created_at)}</td>
          <td class="mono nowrap">${fmt(it.due_at)}</td>
          <td>${fmt(it.canal || '—')}</td>
          <td class="nowrap">${acciones}</td>
        `;

        // Inject the chips in their cells
        tr.children[2].appendChild(prio);
        tr.children[3].appendChild(est);

        tb.appendChild(tr);
      }
    }

    function renderFeed(items){
      const box = $('#feed');
      box.innerHTML = '';
      if(!items.length){
        box.innerHTML = `<div class="muted">Sin actividad reciente.</div>`;
        return;
      }
      for(const it of items){
        const el = document.createElement('div');
        el.className = 'feed-item';
        const action = (it.action || '').toUpperCase();
        const actionClass = (action === 'RESUELTO') ? 'ok' :
                            (action === 'PAUSADO' || action === 'DERIVADO') ? 'warn' :
                            (action === 'CANCELADO') ? 'danger' : '';
        el.innerHTML = `
          <div class="meta">
            <span class="pill mono">#${it.ticket_id}</span>
            <span class="pill ${actionClass}">${action}</span>
            <span class="pill">${it.area || '—'}</span>
            ${it.ubicacion ? `<span class="pill">${it.ubicacion}</span>` : ``}
          </div>
          <div class="subtle">por <strong>${it.actor || 'sistema'}</strong></div>
          <div class="subtle">${fmt(it.at)}</div>
          ${it.motivo ? `<div class="muted">${it.motivo}</div>` : ``}
        `;
        box.appendChild(el);
      }
    }

    // ----------------------- Wiring -----------------------
    let timer = null;

    function applyAutoRefresh(){
      const s = parseInt($('#f-autorefresh').value || '0', 10);
      if(timer){ clearInterval(timer); timer = null; }
      if(s > 0){
        timer = setInterval(async () => {
          try{
            await Promise.all([fetchKPIs(), fetchList(), fetchFeed()]);
          }catch(e){ /* swallow */ }
        }, s*1000);
      }
    }

    async function refreshAll(){
      await Promise.all([fetchKPIs(), fetchList(), fetchFeed()]);
    }

    // Initial state from URL (optional)
    function maybeLoadFromURL(){
      const u = new URL(location.href);
      const estado = u.searchParams.get('estado');
      const period = u.searchParams.get('period');
      const limit  = u.searchParams.get('limit');
      if(estado !== null) $('#f-estado').value = estado;
      if(period !== null) $('#f-periodo').value = period;
      if(limit  !== null) $('#f-limit').value  = limit;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      maybeLoadFromURL();
      $('#btn-apply').addEventListener('click', async () => {
        await fetchList();
        const q = qsFrom(currentFilters());
        history.replaceState(null, '', '?' + q);
      });
      $('#btn-reset').addEventListener('click', async () => {
        $('#f-estado').value = 'PENDIENTE';
        $('#f-periodo').value = 'today';
        $('#f-limit').value = 100;
        await fetchList();
        history.replaceState(null, '', '');
      });
      $('#btn-refresh').addEventListener('click', refreshAll);
      $('#f-autorefresh').addEventListener('change', applyAutoRefresh);

      // First paint
      await refreshAll();
      applyAutoRefresh();
    });
  </script>
</body>
</html>
