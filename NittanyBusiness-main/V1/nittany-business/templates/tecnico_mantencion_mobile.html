{% extends "base.html" %}
{% block title %}Mantenci√≥n ‚Äî Mi trabajo{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-2">
  <h1 class="h4 mb-0">üõ†Ô∏è Mantenci√≥n</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('tickets', estado='PENDIENTE', area='MANTENCION') }}">Todos</a>
    <a class="btn btn-sm btn-accent" href="{{ url_for('ticket_create') }}">Nuevo</a>
  </div>
</header>

<div class="d-flex gap-2 mb-2">
  <select id="flt-prio" class="form-select form-select-sm" style="max-width: 130px">
    <option value="">Prioridad</option>
    <option>URGENTE</option><option>ALTA</option><option>MEDIA</option><option>BAJA</option>
  </select>
  <select id="flt-estado" class="form-select form-select-sm" style="max-width: 130px">
    <option value="">Estado</option>
    <option>PENDIENTE</option><option>ASIGNADO</option><option>ACEPTADO</option>
    <option>EN_CURSO</option><option>PAUSADO</option><option>DERIVADO</option>
  </select>
  <input id="flt-q" class="form-control form-control-sm" placeholder="Buscar..."/>
</div>

<ul id="mnt-list" class="list-unstyled d-grid gap-2">
  {% for t in (tickets or []) %}
  <li class="card {% if t.is_critical %}border-danger{% endif %}"
      data-prio="{{ t.prioridad }}" data-estado="{{ t.estado }}" data-key="{{ (t.ubicacion ~ ' ' ~ t.detalle)|lower }}">
    <div class="card-body p-2">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">{{ t.ubicacion or 'Ubicaci√≥n' }}</div>
          <div class="small text-muted text-truncate" style="max-width: 90vw">{{ t.detalle }}</div>
        </div>
        <div class="text-end">
          <span class="badge {% if t.prioridad=='URGENTE' %}text-bg-danger{% elif t.prioridad=='ALTA' %}text-bg-warning{% elif t.prioridad=='MEDIA' %}text-bg-primary{% else %}text-bg-secondary{% endif %}">{{ t.prioridad }}</span>
          {% if t.due_at %}
            <div class="small {% if t.is_critical %}text-danger fw-semibold{% else %}text-muted{% endif %}">SLA {{ t.due_at }}</div>
          {% else %}
            <div class="small text-muted">Sin SLA</div>
          {% endif %}
        </div>
      </div>

      {% if t.due_at %}
      <div class="progress mt-2" style="height:6px">
        <div class="progress-bar {% if t.is_critical %}bg-danger{% else %}bg-success{% endif %}" style="width: {{ 100 if t.is_critical else 60 }}%"></div>
      </div>
      {% endif %}

      <div class="mt-2 d-flex flex-wrap gap-1">
        {% if t.estado in ['PENDIENTE','ASIGNADO'] %}
          <form method="post" action="{{ url_for('ticket_accept', id=t.id) }}"><button class="btn btn-sm btn-outline-primary">Aceptar</button></form>
        {% endif %}
        {% if t.estado in ['ACEPTADO'] %}
          <form method="post" action="{{ url_for('ticket_start', id=t.id) }}"><button class="btn btn-sm btn-dark">Iniciar</button></form>
          <form method="post" action="{{ url_for('ticket_pause', id=t.id) }}"><input type="hidden" name="motivo" value="Espera repuestos"><button class="btn btn-sm btn-outline-warning">Pausa</button></form>
        {% endif %}
        {% if t.estado in ['EN_CURSO'] %}
          <form method="post" action="{{ url_for('ticket_pause', id=t.id) }}"><input type="hidden" name="motivo" value="Bloqueado"><button class="btn btn-sm btn-outline-warning">Pausa</button></form>
          <form method="post" action="{{ url_for('ticket_finish', id=t.id) }}"><button class="btn btn-sm btn-success">Resolver</button></form>
        {% endif %}
        {% if t.estado in ['PAUSADO'] %}
          <form method="post" action="{{ url_for('ticket_resume', id=t.id) }}"><button class="btn btn-sm btn-outline-secondary">Reanudar</button></form>
        {% endif %}
      </div>

      <div class="mt-2 d-flex justify-content-between small text-muted">
        <span>Estado: {{ t.estado }}</span>
        <span>Creado: {{ t.created_at }}</span>
      </div>
    </div>
  </li>
  {% else %}
    <li class="text-center text-muted py-4">No tienes tickets asignados.</li>
  {% endfor %}
</ul>

<nav class="navbar fixed-bottom bg-white border-top py-2 d-md-none">
  <div class="container-fluid d-flex justify-content-around">
    <a class="btn btn-link" href="{{ url_for('tickets', estado='PENDIENTE', area='MANTENCION') }}">üìã Lista</a>
    <a class="btn btn-link" href="{{ url_for('ticket_create') }}">‚ûï Nuevo</a>
    <a class="btn btn-link" href="{{ url_for('dashboard') }}">üè† Inicio</a>
  </div>
</nav>
{% endblock %}

{% block scripts %}
<script>
  const list = document.getElementById('mnt-list');
  const items = Array.from(list.querySelectorAll('.card'));
  const pr = document.getElementById('flt-prio');
  const st = document.getElementById('flt-estado');
  const q  = document.getElementById('flt-q');
  function apply(){
    const p = pr.value, s = st.value, k=(q.value||'').toLowerCase();
    items.forEach(li=>{
      const okp = !p || li.dataset.prio===p;
      const oks = !s || li.dataset.estado===s;
      const okk = !k || (li.dataset.key||'').includes(k);
      li.style.display = (okp && oks && okk) ? '' : 'none';
    });
  }
  [pr,st,q].forEach(el=>el?.addEventListener('input', apply));
</script>
{% endblock %}
